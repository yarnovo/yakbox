# yakbox 项目记忆

## 一、项目概览

### 项目定位与愿景

**yakbox** 是一个专业级的 React 聊天组件库，旨在为开发者提供高性能、可定制的聊天界面解决方案。项目的核心理念是"专业、高效、易用"，通过现代化的技术架构和精心设计的 API，让开发者能够快速构建出生产级别的聊天应用。

### 核心价值主张

1. **开箱即用的完整方案**
   - 提供从消息展示到输入交互的完整组件体系
   - 内置虚拟滚动、主题系统等高级特性
   - 无需从零开始构建复杂的聊天界面

2. **性能优先的架构设计**
   - 基于 @virtuoso.dev/message-list 的专业虚拟滚动
   - 支持百万级消息的流畅渲染
   - 优化的重渲染策略和内存管理

3. **灵活的定制能力**
   - 主题系统支持视觉风格定制
   - 组件 API 设计支持行为定制
   - TypeScript 完整类型支持

4. **企业级品质保证**
   - 完善的测试覆盖（单元测试、集成测试、视觉测试）
   - 详细的文档和示例（Storybook）
   - 规范的发布流程和版本管理

### 目标用户群体

- **企业应用开发者**: 需要在企业系统中集成聊天功能
- **AI 产品开发者**: 构建对话式 AI 界面，如 ChatGPT 类应用
- **客服系统开发者**: 在线客服、工单系统等实时通讯场景
- **社交应用开发者**: 即时通讯、社区讨论等社交功能

### 技术生态定位

yakbox 在 React 生态中的定位是填补专业聊天组件的空白。不同于简单的 UI 组件库，yakbox 专注于聊天这一垂直领域，提供深度优化的解决方案。项目与现代前端工具链深度集成，支持 SSR、微前端等高级架构模式。

## 二、架构设计

### 整体架构理念

项目采用**分层组件化架构**，遵循以下核心设计原则：

1. **单一职责原则**: 每个组件专注于特定功能域
2. **组合优于继承**: 通过组件组合构建复杂功能
3. **控制反转**: 通过 props、ref 和回调将控制权交给使用者
4. **渐进式增强**: 从基础功能到高级特性的平滑过渡

### 组件架构体系

```
yakbox 组件架构
│
├── 容器层 (Container Layer)
│   └── ChatWindow
│       ├── 职责：整体布局、状态协调、主题应用
│       ├── 特性：主题系统、响应式布局、API 聚合
│       └── 设计：高内聚低耦合，易于扩展
│
├── 功能层 (Feature Layer)
│   ├── MessageList
│   │   ├── 职责：消息列表管理、虚拟滚动
│   │   ├── 特性：百万级消息支持、动态高度处理
│   │   └── 设计：性能优先、内存优化
│   │
│   └── MessageInput
│       ├── 职责：消息输入、发送控制
│       ├── 特性：自适应高度、快捷键支持
│       └── 设计：可访问性、用户体验优先
│
└── 展示层 (Presentation Layer)
    ├── MessageBubble
    │   ├── 职责：单条消息展示
    │   ├── 特性：状态管理、样式定制
    │   └── 设计：纯展示组件、无副作用
    │
    └── UI Components (shadcn/ui)
        └── 提供一致的设计语言和基础组件
```

### 数据流与状态管理

#### 数据流设计原则

1. **单向数据流**
   - Props 向下传递静态配置和初始状态
   - Events 向上传递用户交互和状态变更
   - Refs 提供命令式 API 补充声明式不足

2. **状态最小化**
   - 组件仅维护必要的内部状态
   - 优先使用派生状态而非冗余存储
   - 支持完全受控和非受控两种模式

3. **性能优化策略**
   - 使用 React.memo 和 useMemo 优化重渲染
   - 虚拟滚动只渲染可见区域
   - 批量更新和防抖处理

#### 核心数据模型

```typescript
// 用户模型 - 消息发送者信息
interface ChatUser {
  id: string; // 唯一标识
  name: string; // 显示名称
  avatar: string; // 头像 URL
}

// 消息模型 - 单条消息的完整信息
interface ChatMessage {
  id: string; // 消息唯一标识
  user: ChatUser; // 发送者信息
  message: string; // 消息内容
  timestamp: number; // 时间戳
  failed?: boolean; // 发送失败标记
}

// 组件方法接口 - 命令式 API
interface MessageListMethods {
  send: (message: string) => string; // 发送消息
  receive: (message: Partial<ChatMessage>) => string; // 接收消息
  update: (id: string, updates: Partial<ChatMessage>) => void; // 更新消息
}
```

### 关键技术决策与权衡

#### 1. 虚拟滚动技术选型

**决策**: 选择 @virtuoso.dev/message-list 作为虚拟滚动引擎

**原因**:

- 专为聊天场景优化，支持反向滚动和自动滚动到底部
- 处理动态高度内容的能力优秀
- API 设计简洁，集成成本低

**权衡**:

- 需要商业许可证（生产环境）
- 增加了依赖复杂度
- 但性能提升和功能完整性值得这些成本

#### 2. 样式系统架构

**决策**: Tailwind CSS + CSS Variables 混合方案

**原因**:

- Tailwind 提供快速开发能力和一致性
- CSS Variables 支持运行时主题切换
- 零运行时开销的样式方案

**权衡**:

- 需要使用者项目支持 Tailwind
- 样式覆盖需要了解内部实现
- 但获得了极高的性能和灵活性

#### 3. 组件 API 设计哲学

**决策**: 声明式为主，命令式为辅

**原因**:

- 声明式 API 符合 React 理念，易于理解
- 命令式 API (通过 ref) 处理特殊场景
- 平衡了易用性和灵活性

**实现**:

- Props 处理 90% 的常规场景
- Ref methods 处理消息更新等特殊需求
- 回调函数连接组件与外部逻辑

## 三、核心功能实现

### 主题系统设计

主题系统是 yakbox 的一个重要特性，体现了组件的专业性和灵活性。

#### 设计理念

1. **场景适配**: 不同使用场景需要不同的视觉呈现
2. **最小侵入**: 主题切换不影响功能逻辑
3. **扩展友好**: 易于添加新主题

#### 实现方案

```typescript
// 主题类型定义
type ChatWindowTheme = 'default' | 'borderless';

// 主题样式映射
const themeStyles = {
  default: {
    container: 'rounded-lg border shadow-sm',
    // ... 其他样式
  },
  borderless: {
    container: '', // 无边框样式
    // ... 其他样式
  },
};
```

#### 使用场景

- **默认主题**: 独立使用，如弹出式聊天窗口
- **无边框主题**: 嵌入式使用，如集成到现有页面布局

### 虚拟滚动性能优化

虚拟滚动是处理大量消息的关键技术，yakbox 的实现考虑了多个性能因素。

#### 核心优化策略

1. **只渲染可见区域**: 通过 Intersection Observer 监控可见性
2. **缓冲区设计**: 上下各保留一定数量的离屏元素
3. **高度缓存**: 缓存已测量的元素高度，避免重复计算
4. **批量更新**: 收集多个更新操作，一次性执行

#### 特殊场景处理

- **图片加载**: 预估高度，加载后更新
- **动态内容**: 支持内容变化后的高度调整
- **滚动恢复**: 保持滚动位置的稳定性

### 消息状态管理

消息状态管理体现了组件的健壮性和用户体验考虑。

#### 状态生命周期

```
创建 → 发送中 → 已发送 → (已读)
         ↓
      发送失败 → 重试
```

#### 实现细节

1. **乐观更新**: 立即显示用户消息，后台处理发送
2. **失败处理**: 清晰的失败提示和重试机制
3. **状态持久化**: 支持外部状态管理集成

### 自适应输入组件

MessageInput 组件展示了对用户体验的深度思考。

#### 核心特性

1. **高度自适应**: 根据内容自动调整高度
2. **最大高度限制**: 防止输入框过度扩张
3. **平滑过渡**: 高度变化使用动画过渡

#### 技术实现

```typescript
const adjustHeight = () => {
  const textarea = textareaRef.current;
  if (textarea) {
    textarea.style.height = 'auto';
    const newHeight = Math.min(textarea.scrollHeight, maxHeight);
    textarea.style.height = `${newHeight}px`;
  }
};
```

## 四、开发实践与工程化

### 开发流程标准化

1. **组件开发流程**
   - Storybook 驱动开发：先写故事，后写组件
   - 类型优先：先定义接口，后实现逻辑
   - 测试覆盖：单元测试 + 集成测试 + 视觉测试

2. **代码质量保证**
   - ESLint + Prettier 统一代码风格
   - Husky + lint-staged 自动化检查
   - TypeScript 严格模式确保类型安全

3. **文档规范**
   - 组件必须有完整的 Props 文档
   - 复杂功能需要使用示例
   - API 变更需要迁移指南

### CI/CD 与发布策略

#### 自动化流程

1. **持续集成**
   - 所有 PR 触发：lint、类型检查、测试
   - 覆盖率报告自动生成
   - 性能基准测试（计划中）

2. **自动发布**
   - 版本标签触发 NPM 发布
   - 语义化版本严格校验
   - 自动生成 CHANGELOG（计划中）

3. **文档部署**
   - Storybook 自动部署到 GitHub Pages
   - 版本化文档支持（计划中）

#### 版本管理策略

- **正式版**: 1.0.0, 1.1.0 等
- **预发布版**: 1.0.0-alpha.1, 1.0.0-beta.1
- **开发版**: 0.1.0-dev.0（当前阶段）

### 性能监控与优化

1. **关键指标**
   - 首次渲染时间 (FCP)
   - 滚动帧率 (FPS)
   - 内存使用趋势

2. **优化手段**
   - 组件懒加载
   - 代码分割
   - 资源预加载

## 五、知识沉淀与最佳实践

### 组件设计模式

1. **复合组件模式**: ChatWindow 作为容器组合子组件
2. **受控组件模式**: 支持完全受控的消息管理
3. **Ref 转发模式**: 暴露内部方法给外部使用

### 性能优化经验

1. **虚拟滚动调优**
   - 合适的缓冲区大小：可见区域的 2-3 倍
   - 防抖滚动事件：避免频繁重算
   - 批量 DOM 操作：减少重排重绘

2. **React 优化技巧**
   - 合理使用 memo 和 useMemo
   - 避免内联函数和对象
   - 状态下沉，减少不必要的重渲染

### 可访问性实践

1. **键盘导航**: 支持 Tab 键和方向键
2. **屏幕阅读器**: 正确的 ARIA 标签
3. **颜色对比度**: 符合 WCAG 2.1 标准

## 六、未来规划与愿景

### 短期目标（3-6 个月）

1. **功能完善**
   - 消息搜索功能
   - 表情包支持
   - 文件上传能力

2. **性能提升**
   - Web Worker 渲染（实验性）
   - 增量渲染优化
   - 内存使用优化

3. **生态建设**
   - 官方示例项目
   - 第三方集成指南
   - 社区插件机制

### 长期愿景（1-2 年）

1. **跨框架支持**
   - Vue 版本
   - Web Components 版本
   - React Native 版本

2. **AI 能力集成**
   - 智能回复建议
   - 情感分析
   - 多语言翻译

3. **企业级特性**
   - 端到端加密
   - 消息审计
   - 合规性支持

## 七、项目文化与价值观

### 核心价值观

1. **用户至上**: 每个决策都从用户角度出发
2. **追求卓越**: 不满足于"能用"，追求"好用"
3. **开放协作**: 欢迎社区贡献，共同成长
4. **持续学习**: 保持对新技术的敏感度

### 设计哲学

1. **简约而不简单**: API 简洁，功能强大
2. **渐进式复杂度**: 简单场景简单用，复杂场景有方案
3. **最小惊讶原则**: 行为符合直觉和预期

---

_此记忆文档持续演进，记录项目的成长历程和知识沉淀_

<!-- 最后检查时间: 2025-07-09T14:30:00+08:00 -->
